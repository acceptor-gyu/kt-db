# kt-db

Kotlinìœ¼ë¡œ êµ¬í˜„í•˜ëŠ” ê´€ê³„í˜• ë°ì´í„°ë² ì´ìŠ¤

ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ì²˜ìŒë¶€í„° êµ¬í˜„í•˜ë©´ì„œ Kotlinê³¼ ë„¤íŠ¸ì›Œí¬ í”„ë¡œê·¸ë˜ë°, ë™ì‹œì„± ì œì–´, íŒŒì¼ I/Oë¥¼ í•™ìŠµí•˜ëŠ” í”„ë¡œì íŠ¸ì…ë‹ˆë‹¤.

## âœ¨ ì£¼ìš” ê¸°ëŠ¥

- **ğŸ“¦ íŒŒì¼ ê¸°ë°˜ ì˜ì†ì„±**: ë°”ì´ë„ˆë¦¬ í˜•ì‹ìœ¼ë¡œ í…Œì´ë¸” ë°ì´í„°ë¥¼ ë””ìŠ¤í¬ì— ì €ì¥ (ì„œë²„ ì¬ì‹œì‘ í›„ ë³µì›)
- **âš¡ Buffer Pool (í˜ì´ì§€ ìºì‹±)**: 16KB í˜ì´ì§€ ë‹¨ìœ„ LRU ìºì‹œë¡œ ë””ìŠ¤í¬ I/O ìµœì†Œí™” (99% hit rate ì‹œ 100ë°° ì„±ëŠ¥ í–¥ìƒ)
- **ğŸ” EXPLAIN ì¿¼ë¦¬ ë¶„ì„**: Elasticsearch ê¸°ë°˜ ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš ìƒì„± ë° ìµœì í™”
- **ğŸ”’ Thread-Safe ì„¤ê³„**: ConcurrentHashMapê³¼ atomic operationìœ¼ë¡œ ë™ì‹œì„± ë³´ì¥
- **ğŸš€ Docker ë¹Œë“œ ìµœì í™”**: ë ˆì´ì–´ ìºì‹±ìœ¼ë¡œ ì¬ë¹Œë“œ ì‹œê°„ 90% ë‹¨ì¶• (5ë¶„ â†’ 30ì´ˆ)
- **ğŸŒ ë©€í‹° í´ë¼ì´ì–¸íŠ¸ ì§€ì›**: TCP í”„ë¡œí† ì½œë¡œ ë™ì‹œ ë‹¤ì¤‘ ì—°ê²° ì²˜ë¦¬
- **ğŸ“Š ì¿¼ë¦¬ ë¡œê¹…**: Elasticsearchì— ì¿¼ë¦¬ ì‹¤í–‰ ì´ë ¥ ì €ì¥ ë° Kibanaë¡œ ì‹œê°í™”

## ğŸ“‹ ì§€ì› ê¸°ëŠ¥

### SQL ëª…ë ¹ì–´

| ëª…ë ¹ì–´ | í˜•ì‹ | ì˜ˆì‹œ |
|--------|------|------|
| **CREATE TABLE** | `CREATE TABLE <name> (col type, ...)` | `CREATE TABLE users (id INT, name VARCHAR, age INT)` |
| **INSERT** | `INSERT INTO <table> VALUES (col="val", ...)` | `INSERT INTO users VALUES (id="1", name="John", age="30")` |
| **SELECT** | `SELECT * FROM <table>` | `SELECT * FROM users` |
| **DROP TABLE** | `DROP TABLE <name>` | `DROP TABLE users` |
| **EXPLAIN** | `EXPLAIN SELECT * FROM <table>` | `EXPLAIN SELECT * FROM users WHERE name='Alice'` |
| **PING** | `PING` | `PING` (ì—°ê²° í™•ì¸) |

### ë°ì´í„° íƒ€ì…

| íƒ€ì… | í¬ê¸° | ë²”ìœ„/ì„¤ëª… | ì˜ˆì‹œ |
|------|------|-----------|------|
| **INT** | 4 bytes | ì •ìˆ˜í˜• (-2,147,483,648 ~ 2,147,483,647) | `42`, `-100` |
| **VARCHAR** | ê°€ë³€ | ë¬¸ìì—´ (ìµœëŒ€ 65,535 bytes) | `"Hello"`, `"ê¹€ì² ìˆ˜"` |
| **BOOLEAN** | 1 byte | true/false | `true`, `false` |
| **TIMESTAMP** | 8 bytes | ë‚ ì§œ/ì‹œê°„ (ISO 8601 í˜•ì‹) | `"2024-01-15T10:30:00Z"` |

### ë°”ì´ë„ˆë¦¬ íŒŒì¼ ì¸ì½”ë”©

- **INT**: 4 bytes, Big Endian
- **VARCHAR**: `[2-byte length][UTF-8 bytes]`
- **BOOLEAN**: 1 byte (`0x00` = false, `0x01` = true)
- **TIMESTAMP**: 8 bytes, Unix timestamp milliseconds

### ì œí•œì‚¬í•­

**í˜„ì¬ ë¯¸ì§€ì› ê¸°ëŠ¥:**
- âŒ WHERE ì ˆ (ì¡°ê±´ë¶€ SELECT)
- âŒ UPDATE ë¬¸
- âŒ DELETE ë¬¸ (ë ˆì½”ë“œ ì‚­ì œ)
- âŒ JOIN ì—°ì‚°
- âŒ ì¸ë±ìŠ¤ (EXPLAIN ë¶„ì„ìš© ë©”íƒ€ë°ì´í„°ë§Œ ì¡´ì¬)
- âŒ íŠ¸ëœì­ì…˜ (COMMIT/ROLLBACK)
- âŒ NULL ê°’

**ì œì•½ ì¡°ê±´:**
- SELECTëŠ” ì „ì²´ í…Œì´ë¸” ìŠ¤ìº”ë§Œ ì§€ì› (`SELECT * FROM table`)
- í…Œì´ë¸”ë‹¹ í•˜ë‚˜ì˜ íŒŒì¼ë¡œ ì €ì¥ (íŒŒí‹°ì…”ë‹ ë¯¸ì§€ì›)
- ë™ì‹œ ì“°ê¸°ëŠ” thread-safeí•˜ì§€ë§Œ ìµœì í™”ëŠ” ì œí•œì 

## í”„ë¡œì íŠ¸ êµ¬ì¡°

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        Client Apps                           â”‚
â”‚                    (Multiple Connections)                    â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚ TCP/IP
                     â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                       DbTcpServer                            â”‚
â”‚  - í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ìˆ˜ë½                                        â”‚
â”‚  - ConnectionManager, TableService ì‹±ê¸€í†¤ ê´€ë¦¬                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
            â”‚
            â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
            â–¼                  â–¼                  â–¼
    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”   â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
    â”‚ Connection #1â”‚   â”‚ Connection #2â”‚   â”‚ Connection #Nâ”‚
    â”‚  Handler     â”‚   â”‚  Handler     â”‚   â”‚  Handler     â”‚
    â”‚ (Thread A)   â”‚   â”‚ (Thread B)   â”‚   â”‚ (Thread N)   â”‚
    â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
           â”‚                  â”‚                  â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚ ê³µìœ  ì ‘ê·¼ (Thread-safe)
                              â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚       ConnectionManager              â”‚
           â”‚  - Connection ID ìƒì„± (AtomicLong)   â”‚
           â”‚  - í™œì„± ì—°ê²° ì¶”ì  (ConcurrentHashMap)â”‚
           â”‚  - register() / unregister()         â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                              â”‚
                              â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚         TableService                 â”‚
           â”‚  - í…Œì´ë¸” ìƒì„±/ì¡°íšŒ/ì‚­ì œ/ìˆ˜ì •          â”‚
           â”‚  - ConcurrentHashMap ê¸°ë°˜            â”‚
           â”‚  - Atomic Operations (compute ë“±)   â”‚
           â”‚  - ëª¨ë“  ì—°ê²°ì´ ê³µìœ í•˜ëŠ” ë‹¨ì¼ ì¸ìŠ¤í„´ìŠ¤   â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### ì£¼ìš” ì»´í¬ë„ŒíŠ¸

#### 1. DbTcpServer
- **ì—­í• **: TCP ì—°ê²° ìˆ˜ë½ ë° ConnectionHandler ìƒì„±
- **ì¸ìŠ¤í„´ìŠ¤**: 1ê°œ (ì„œë²„ ì‹œì‘ ì‹œ)
- **ì±…ì„**:
  - ServerSocketìœ¼ë¡œ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ìˆ˜ë½
  - ConnectionManagerì™€ TableService ì‹±ê¸€í†¤ ê´€ë¦¬
  - ê° ì—°ê²°ë§ˆë‹¤ ìƒˆ ConnectionHandler ìƒì„± ë° ìŠ¤ë ˆë“œ í’€ì— ì œì¶œ

#### 2. ConnectionManager
- **ì—­í• **: ì—°ê²° ìƒëª…ì£¼ê¸° ê´€ë¦¬
- **ì¸ìŠ¤í„´ìŠ¤**: 1ê°œ (DbTcpServerê°€ ì†Œìœ )
- **ì±…ì„**:
  - Connection ID ìƒì„± (AtomicLong ê¸°ë°˜)
  - í™œì„± ì—°ê²° ì¶”ì  (ConcurrentHashMap)
  - ì—°ê²° ë“±ë¡/í•´ì œ
  - SHOW PROCESSLIST, KILL ëª…ë ¹ ì§€ì› (í–¥í›„)

#### 3. ConnectionHandler
- **ì—­í• **: ê°œë³„ í´ë¼ì´ì–¸íŠ¸ ì—°ê²° ì²˜ë¦¬
- **ì¸ìŠ¤í„´ìŠ¤**: í´ë¼ì´ì–¸íŠ¸ ì—°ê²°ë‹¹ 1ê°œ
- **ì±…ì„**:
  - SQL ë¬¸ìì—´ ìˆ˜ì‹  ë° íŒŒì‹±
  - í´ë¼ì´ì–¸íŠ¸ ëª…ë ¹ ì²˜ë¦¬
  - TableService í˜¸ì¶œ
  - ì—°ê²° ì¢…ë£Œ ì‹œ ë¦¬ì†ŒìŠ¤ ì •ë¦¬ ë° ConnectionManagerì—ì„œ unregister

#### 4. TableService
- **ì—­í• **: í…Œì´ë¸” ë°ì´í„° ê´€ë¦¬ (In-memory ìºì‹œ + íŒŒì¼ ê¸°ë°˜ ì˜ì†ì„±)
- **ì¸ìŠ¤í„´ìŠ¤**: 1ê°œ (ëª¨ë“  ì—°ê²°ì´ ê³µìœ )
- **ì €ì¥ ë°©ì‹**:
  - In-memory: `ConcurrentHashMap`ìœ¼ë¡œ ë¹ ë¥¸ ì“°ê¸°/ì½ê¸°
  - Disk: `./data/*.dat` ë°”ì´ë„ˆë¦¬ íŒŒì¼ë¡œ ì˜êµ¬ ì €ì¥
  - SELECT: ë””ìŠ¤í¬ì—ì„œ ì§ì ‘ ì½ê¸° (full table scan)
- **Thread-Safety**:
  - `ConcurrentHashMap` ì‚¬ìš©
  - `compute()`, `putIfAbsent()` ë“± atomic operation
  - íŒŒì¼ ì“°ê¸°ëŠ” atomic write (temp file â†’ sync â†’ rename)
  - ì—¬ëŸ¬ ConnectionHandlerì˜ ë™ì‹œ ì ‘ê·¼ ì•ˆì „

### ë””ìŠ¤í¬ ê¸°ë°˜ ì˜ì†ì„± (Disk I/O)

ë°ì´í„°ë² ì´ìŠ¤ëŠ” íŒŒì¼ ê¸°ë°˜ ì˜ì†ì„±ì„ ì§€ì›í•˜ì—¬ ì„œë²„ ì¬ì‹œì‘ í›„ì—ë„ ë°ì´í„°ê°€ ë³´ì¡´ë©ë‹ˆë‹¤.

#### ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                     TableService                             â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚      In-Memory Cache (ConcurrentHashMap)      â”‚          â”‚
â”‚  â”‚         - ë¹ ë¥¸ ì“°ê¸° ì„±ëŠ¥                        â”‚          â”‚
â”‚  â”‚         - Thread-safe ë™ì‹œ ì ‘ê·¼                â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â”‚                    â”‚                                         â”‚
â”‚                    â–¼                                         â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”          â”‚
â”‚  â”‚          TableFileManager                      â”‚          â”‚
â”‚  â”‚   - CREATE TABLE: íŒŒì¼ ìƒì„± (*.dat)           â”‚          â”‚
â”‚  â”‚   - INSERT: íŒŒì¼ ì—…ë°ì´íŠ¸                      â”‚          â”‚
â”‚  â”‚   - SELECT: íŒŒì¼ì—ì„œ ì§ì ‘ ì½ê¸° (full scan)     â”‚          â”‚
â”‚  â”‚   - DROP TABLE: íŒŒì¼ ì‚­ì œ                      â”‚          â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜          â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚
                     â–¼
           â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
           â”‚    Disk Storage     â”‚
           â”‚  ./data/            â”‚
           â”‚  â”œâ”€ users.dat       â”‚
           â”‚  â”œâ”€ products.dat    â”‚
           â”‚  â””â”€ orders.dat      â”‚
           â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ë°”ì´ë„ˆë¦¬ íŒŒì¼ í¬ë§·

ê° í…Œì´ë¸”ì€ `.dat` íŒŒì¼ë¡œ ì €ì¥ë˜ë©°, ë‹¤ìŒê³¼ ê°™ì€ êµ¬ì¡°ë¥¼ ê°€ì§‘ë‹ˆë‹¤:

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ File Header (24 bytes)              â”‚
â”‚  - Magic: 0xDBF0 (2 bytes)          â”‚
â”‚  - Version: 1 (2 bytes)             â”‚
â”‚  - Row Count: long (8 bytes)        â”‚
â”‚  - Column Count: int (4 bytes)      â”‚
â”‚  - Schema Length: int (4 bytes)     â”‚
â”‚  - Reserved: (4 bytes)              â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Schema Section (variable)           â”‚
â”‚  For each column:                   â”‚
â”‚   - Name Length: short (2 bytes)    â”‚
â”‚   - Name: UTF-8 bytes               â”‚
â”‚   - Type: byte (1 byte)             â”‚
â”‚     0x01=INT, 0x02=VARCHAR,         â”‚
â”‚     0x03=TIMESTAMP, 0x04=BOOLEAN    â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ Data Section (variable)             â”‚
â”‚  For each row:                      â”‚
â”‚   - Row Length: int (4 bytes)       â”‚
â”‚   - Field Data (type-specific):     â”‚
â”‚     INT: 4 bytes (Big Endian)       â”‚
â”‚     VARCHAR: [2-byte len][UTF-8]    â”‚
â”‚     TIMESTAMP: 8 bytes (Unix ms)    â”‚
â”‚     BOOLEAN: 1 byte (0x00/0x01)     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

#### ì˜ì†ì„± ë™ì‘

**CREATE TABLE**:
```kotlin
tableService.createTable("users", mapOf("id" to "INT", "name" to "VARCHAR"))
// â†’ íŒŒì¼ ìƒì„±: ./data/users.dat
```

**INSERT**:
```kotlin
tableService.insert("users", mapOf("id" to "1", "name" to "Alice"))
// â†’ íŒŒì¼ ì—…ë°ì´íŠ¸: users.datì— row ì¶”ê°€
```

**SELECT (Full Table Scan)**:
```kotlin
val table = tableService.select("users")
// â†’ íŒŒì¼ì—ì„œ ì§ì ‘ ì½ê¸°: users.datë¥¼ ë””ì½”ë”©í•˜ì—¬ Table ê°ì²´ ë°˜í™˜
```

**ì„œë²„ ì¬ì‹œì‘**:
```kotlin
// 1. ì„œë²„ ì‹œì‘ ì‹œ TableService ì´ˆê¸°í™”
// 2. TableFileManagerê°€ ./data/ ë””ë ‰í† ë¦¬ì˜ ëª¨ë“  .dat íŒŒì¼ ìŠ¤ìº”
// 3. ê° íŒŒì¼ì„ ì½ì–´ì„œ Table ê°ì²´ë¡œ ë³µì›
// 4. In-memory cacheì— ë¡œë“œ
```

**DROP TABLE**:
```kotlin
tableService.dropTable("users")
// â†’ íŒŒì¼ ì‚­ì œ: ./data/users.dat ì œê±°
```

#### ë°ì´í„° ë¬´ê²°ì„± ë³´ì¥

- **Atomic Writes**: Temp file â†’ sync â†’ rename íŒ¨í„´ìœ¼ë¡œ ì›ìì  ì“°ê¸° ë³´ì¥
- **Crash Recovery**: íŒŒì¼ì´ ì™„ì „íˆ ì“°ì—¬ì§€ì§€ ì•Šìœ¼ë©´ temp íŒŒì¼ë§Œ ë‚¨ê³  ì›ë³¸ì€ ë³´ì¡´ë¨
- **Thread-Safe**: íŒŒì¼ ì“°ê¸°ëŠ” TableServiceì˜ ConcurrentHashMap atomic operationê³¼ í†µí•©

#### ì„¤ì •

`application.properties`:
```properties
db.storage.directory=./data
db.storage.enabled=true
```

## ìš”ì²­ ì²˜ë¦¬ íë¦„

### í”„ë¡œí† ì½œ ê°œìš”

**ë‹¨ìˆœí™”ëœ String ê¸°ë°˜ í”„ë¡œí† ì½œ:**
- í´ë¼ì´ì–¸íŠ¸ â†’ ì„œë²„: SQL ë¬¸ìì—´ (UTF-8 ì¸ì½”ë”©)
- ì„œë²„ â†’ í´ë¼ì´ì–¸íŠ¸: JSON í˜•ì‹ì˜ DbResponse

```
Client                          Server
  â”‚                               â”‚
  â”‚  [Length: 4 bytes]            â”‚
  â”‚  [SQL String: "SELECT ..."]   â”‚
  â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
  â”‚                               â”‚
  â”‚  [Length: 4 bytes]            â”‚
  â”‚  [JSON Response: {...}]       â”‚
  â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
```

### ìƒì„¸ ì²˜ë¦¬ íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                                              â”‚ DbTcpServer  â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                           â”‚
     â”‚ 1. TCP Connection Request                                â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                                           â”‚
     â”‚                                    2. Generate Connection ID
     â”‚                                       (ConnectionManager.generateConnectionId())
     â”‚                                                           â”‚
     â”‚                                    3. Create ConnectionHandler
     â”‚                                       - connectionId: 1   â”‚
     â”‚                                       - socket            â”‚
     â”‚                                       - tableService      â”‚
     â”‚                                       - connectionManager â”‚
     â”‚                                                           â”‚
     â”‚                                    4. Register Connection
     â”‚                                       (ConnectionManager.register())
     â”‚                                                           â”‚
     â”‚                                    5. Submit to Thread Pool
     â”‚                                       (executor.submit())
     â”‚                                                           â”‚
     â”‚                                                      â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                                      â”‚Connection   â”‚
     â”‚                                                      â”‚Handler #1   â”‚
     â”‚                                                      â”‚(Thread A)   â”‚
     â”‚                                                      â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 6. SQL Request (String)                                  â”‚
     â”‚    ProtocolCodec.encodeRequest("CREATE TABLE users ...") â”‚
     â”‚    â†’ [4-byte length][UTF-8 SQL string]                   â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                                           â”‚
     â”‚                                      7. Decode SQL String
     â”‚                                         ProtocolCodec.decodeRequest()
     â”‚                                         â†’ "CREATE TABLE users ..."
     â”‚                                                           â”‚
     â”‚                                      8. Parse SQL        â”‚
     â”‚                                         - CREATE TABLE   â”‚
     â”‚                                         - INSERT INTO    â”‚
     â”‚                                         - SELECT         â”‚
     â”‚                                         - EXPLAIN        â”‚
     â”‚                                         - PING           â”‚
     â”‚                                                           â”‚
     â”‚                                      9. Call TableService
     â”‚                                          (thread-safe)   â”‚
     â”‚                                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
     â”‚                                          â”‚TableService â”‚ â”‚
     â”‚                                          â”‚(Shared)     â”‚ â”‚
     â”‚                                          â”‚ConcurrentMapâ”‚ â”‚
     â”‚                                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
     â”‚                                               â”‚          â”‚
     â”‚                                      10. Execute Operation
     â”‚                                          (CREATE/INSERT/SELECT)
     â”‚                                               â”‚          â”‚
     â”‚                                          â”Œâ”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â” â”‚
     â”‚                                          â”‚  Result     â”‚ â”‚
     â”‚                                          â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â”‚
     â”‚                                               â”‚          â”‚
     â”‚                                      11. Create DbResponse
     â”‚                                          { success: true,
     â”‚                                            message: "...",
     â”‚                                            data: "..." }
     â”‚                                                           â”‚
     â”‚ 12. JSON Response                                        â”‚
     â”‚     ProtocolCodec.encodeResponse(DbResponse)             â”‚
     â”‚     â†’ [4-byte length][UTF-8 JSON]                        â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                           â”‚
     â”‚ 13. Close Connection                                     â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                                           â”‚
     â”‚                                      14. Close Resources â”‚
     â”‚                                          - input.close() â”‚
     â”‚                                          - output.close()â”‚
     â”‚                                          - socket.close()â”‚
     â”‚                                                           â”‚
     â”‚                                      15. Unregister      â”‚
     â”‚                                          (ConnectionManager.unregister())
     â”‚                                                           â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Thread-Safety ë³´ì¥

### ConnectionManager
- `AtomicLong`ì„ ì‚¬ìš©í•œ Connection ID ìƒì„± (ë™ì‹œ í˜¸ì¶œ ì‹œ ê³ ìœ  ID ë³´ì¥)
- `ConcurrentHashMap`ìœ¼ë¡œ í™œì„± ì—°ê²° ì¶”ì  (ë™ì‹œ ì½ê¸°/ì“°ê¸° ì•ˆì „)

### TableService
- `ConcurrentHashMap` ì‚¬ìš©
- **Atomic Operations**:
  - `createTable()`: `putIfAbsent()` - ì¤‘ë³µ ìƒì„± ë°©ì§€
  - `insert()`: `compute()` - read-modify-writeë¥¼ atomicí•˜ê²Œ ì²˜ë¦¬
  - `dropTable()`: `remove()` - atomic ì‚­ì œ

#### insert() Race Condition ë°©ì§€ ì˜ˆì‹œ

```kotlin
// âŒ Thread-unsafe (Race Condition ë°œìƒ!)
val table = tables[tableName]           // Thread A, B ë™ì‹œ ì½ê¸°
val updated = table.copy(value = ...)   // Thread A, B ê°ì ìˆ˜ì •
tables[tableName] = updated             // í•˜ë‚˜ì˜ ìˆ˜ì •ì´ ì†ì‹¤ë¨!

// âœ… Thread-safe (Atomic Operation)
tables.compute(tableName) { _, existingTable ->
    existingTable?.copy(value = existingTable.value + values)
}
// compute() ë‚´ë¶€ëŠ” í•˜ë‚˜ì˜ atomic operation
// Thread BëŠ” Thread Aê°€ ëë‚  ë•Œê¹Œì§€ ëŒ€ê¸°
```

## Connection ID ê´€ë¦¬

```kotlin
// ì´ˆê¸° ìƒíƒœ
connectionIdGenerator = AtomicLong(0)

// ì—°ê²° 1~10 ìƒì„±
generateConnectionId() â†’ 1, 2, 3, ..., 10

// ì—°ê²° 3, 7 ì¢…ë£Œ
unregister(3)  // ID generatorëŠ” ë³€í•˜ì§€ ì•ŠìŒ (ì—¬ì „íˆ 10)
unregister(7)  // connections Mapì—ì„œë§Œ ì œê±°

// ìƒˆ ì—°ê²° 5ê°œ ìƒì„±
generateConnectionId() â†’ 11, 12, 13, 14, 15  // 3ê³¼ 7ì„ ì¬ì‚¬ìš©í•˜ì§€ ì•ŠìŒ!

// í™œì„± ì—°ê²°: {1, 2, 4, 5, 6, 8, 9, 10, 11, 12, 13, 14, 15}
// IDëŠ” ì ˆëŒ€ ì¬ì‚¬ìš©ë˜ì§€ ì•ŠìŒ (ë¡œê·¸ ì¶”ì ì— ìœ ë¦¬)
```

## EXPLAIN ìš”ì²­ ì²˜ë¦¬ íë¦„

`EXPLAIN` ëª…ë ¹ì€ SQL ì¿¼ë¦¬ì˜ ì‹¤í–‰ ê³„íšì„ ìƒì„±í•˜ì—¬ ì˜µí‹°ë§ˆì´ì €ê°€ ì–´ë–»ê²Œ ì¿¼ë¦¬ë¥¼ ì‹¤í–‰í• ì§€ ë³´ì—¬ì¤ë‹ˆë‹¤. MySQLì˜ `EXPLAIN` ëª…ë ¹ê³¼ ìœ ì‚¬í•©ë‹ˆë‹¤.

### EXPLAIN ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          EXPLAIN Command                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚   ConnectionHandler            â”‚
                 â”‚   handleExplain(request)       â”‚
                 â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                 â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                 â”‚      ExplainService            â”‚
                 â”‚   explain(sql): QueryPlan      â”‚
                 â””â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                     â”‚     â”‚      â”‚      â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚            â”‚     â”‚      â”‚      â”‚            â”‚
        â–¼            â–¼     â–¼      â–¼      â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â” â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  SqlParser   â”‚ â”‚Table â”‚ â”‚Indexâ”‚ â”‚Tableâ”‚ â”‚  QueryPlan   â”‚
â”‚              â”‚ â”‚Meta  â”‚ â”‚Meta â”‚ â”‚Statsâ”‚ â”‚  Repository  â”‚
â”‚ parseQuery() â”‚ â”‚Serviceâ”‚ â”‚Serviceâ”‚ â”‚Serviceâ”‚ â”‚              â”‚
â”‚              â”‚ â”‚      â”‚ â”‚    â”‚ â”‚    â”‚ â”‚ save(plan)   â”‚
â”‚ ParsedQuery  â”‚ â”‚existsâ”‚ â”‚shouldâ”‚ â”‚calcâ”‚ â”‚              â”‚
â”‚  - tableName â”‚ â”‚columnsâ”‚ â”‚Use   â”‚ â”‚Sel.â”‚ â”‚              â”‚
â”‚  - where[]   â”‚ â”‚      â”‚ â”‚Index â”‚ â”‚    â”‚ â”‚              â”‚
â”‚  - select[]  â”‚ â”‚      â”‚ â”‚      â”‚ â”‚    â”‚ â”‚              â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”˜ â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                                       â”‚
        â”‚                                       â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                        â”‚
        â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
        â”‚      ExecutionStep ìƒì„±         â”‚
        â”‚                                 â”‚
        â”‚  - TABLE_SCAN                   â”‚
        â”‚  - INDEX_SCAN                   â”‚
        â”‚  - COVERED_INDEX_SCAN           â”‚
        â”‚                                 â”‚
        â”‚  ë¹„ìš© ê³„ì‚°:                       â”‚
        â”‚  - INDEX_SCAN: log2(N)*sel*N    â”‚
        â”‚  - TABLE_SCAN: N                â”‚
        â”‚  - Selectivity: distinct/total  â”‚
        â”‚                                 â”‚
        â”‚  Covered Query íŒë‹¨:             â”‚
        â”‚  1. WHERE ì»¬ëŸ¼ = leading column â”‚
        â”‚  2. SELECT ì»¬ëŸ¼ âŠ† ì¸ë±ìŠ¤ ì»¬ëŸ¼     â”‚
        â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### EXPLAIN ì²˜ë¦¬ ë‹¨ê³„ (ìƒì„¸)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                                              â”‚  DB Server       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                            â”‚
     â”‚ 1. EXPLAIN Query (sql: "SELECT * FROM users WHERE...")    â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                                            â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚   ConnectionHandler           â”‚
     â”‚                                    â”‚   handleExplain(request)      â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                            â”‚
     â”‚                                    2. Extract SQL from request
     â”‚                                       sql = request.sql    â”‚
     â”‚                                                            â”‚
     â”‚                                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”
     â”‚                                    â”‚      ExplainService           â”‚
     â”‚                                    â”‚      explain(sql)             â”‚
     â”‚                                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                            â”‚
     â”‚                                    3. SQL íŒŒì‹± (SqlParser)
     â”‚                                       ParsedQuery:         â”‚
     â”‚                                       - tableName: "users" â”‚
     â”‚                                       - where: [name="Alice"]
     â”‚                                       - select: ["*"]      â”‚
     â”‚                                                            â”‚
     â”‚                                    4. í…Œì´ë¸” ë©”íƒ€ë°ì´í„° ì¡°íšŒ
     â”‚                                       tableMetadataService.tableExists()
     â”‚                                       tableMetadataService.getColumns()
     â”‚                                                            â”‚
     â”‚                                    5. ì¸ë±ìŠ¤ ê²°ì • (IndexMetadataService)
     â”‚                                       shouldUseIndexScan(table, column, selectivity)
     â”‚                                       â†’ IndexScanDecision:  â”‚
     â”‚                                         - useIndex: true/false
     â”‚                                         - selectedIndex: "idx_name"
     â”‚                                         - reason: "..."    â”‚
     â”‚                                                            â”‚
     â”‚                                    6. ì„ íƒë„(Selectivity) ê³„ì‚°
     â”‚                                       tableStatisticsService.calculateSelectivity()
     â”‚                                       selectivity = distinctCount / totalRows
     â”‚                                                            â”‚
     â”‚                                    7. ExecutionStep ìƒì„±
     â”‚                                       if (useIndex && isCovered)
     â”‚                                         â†’ COVERED_INDEX_SCAN
     â”‚                                       else if (useIndex)    â”‚
     â”‚                                         â†’ INDEX_SCAN       â”‚
     â”‚                                       else                 â”‚
     â”‚                                         â†’ TABLE_SCAN       â”‚
     â”‚                                                            â”‚
     â”‚                                    8. ë¹„ìš© ê³„ì‚°             â”‚
     â”‚                                       INDEX_SCAN:          â”‚
     â”‚                                         cost = log2(totalRows) + totalRows * selectivity
     â”‚                                       TABLE_SCAN:          â”‚
     â”‚                                         cost = totalRows   â”‚
     â”‚                                                            â”‚
     â”‚                                    9. Covered Query íŒë‹¨
     â”‚                                       ì¡°ê±´ 1: whereColumn == indexColumns[0]
     â”‚                                       ì¡°ê±´ 2: selectColumns âŠ† indexColumns
     â”‚                                                            â”‚
     â”‚                                    10. QueryPlan ìƒì„±
     â”‚                                        QueryPlan:          â”‚
     â”‚                                        - planId: UUID      â”‚
     â”‚                                        - queryHash: MD5(sql)
     â”‚                                        - executionSteps: [] â”‚
     â”‚                                        - estimatedCost: 123.45
     â”‚                                        - estimatedRows: 500 â”‚
     â”‚                                        - isCoveredQuery: true/false
     â”‚                                                            â”‚
     â”‚                                    11. Elasticsearch ì €ì¥
     â”‚                                        queryPlanRepository.save(queryPlan)
     â”‚                                        â†’ Index: db-query-plans
     â”‚                                                            â”‚
     â”‚ 12. QueryPlan JSON ì‘ë‹µ                                    â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”‚
     â”‚    {                                                       â”‚
     â”‚      "planId": "uuid-...",                                 â”‚
     â”‚      "executionSteps": [                                   â”‚
     â”‚        {                                                   â”‚
     â”‚          "stepType": "COVERED_INDEX_SCAN",                 â”‚
     â”‚          "tableName": "users",                             â”‚
     â”‚          "indexUsed": "idx_name_email",                    â”‚
     â”‚          "filterCondition": "name = 'Alice'",              â”‚
     â”‚          "columnsAccessed": ["name", "email"],             â”‚
     â”‚          "estimatedCost": 15.3,                            â”‚
     â”‚          "estimatedRows": 10,                              â”‚
     â”‚          "isCovered": true,                                â”‚
     â”‚          "description": "Using covering index..."          â”‚
     â”‚        }                                                   â”‚
     â”‚      ],                                                    â”‚
     â”‚      "estimatedCost": 15.3,                                â”‚
     â”‚      "estimatedRows": 10,                                  â”‚
     â”‚      "isCoveredQuery": true                                â”‚
     â”‚    }                                                       â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### Covered Query íŒë‹¨ ë¡œì§

**Covered Query**ëŠ” ì¸ë±ìŠ¤ë§Œìœ¼ë¡œ ì¿¼ë¦¬ë¥¼ ì™„ì „íˆ ì²˜ë¦¬í•  ìˆ˜ ìˆì–´ í…Œì´ë¸” ë°ì´í„°ë¥¼ ì½ì§€ ì•Šì•„ë„ ë˜ëŠ” ìµœì í™”ëœ ì¿¼ë¦¬ì…ë‹ˆë‹¤.

```kotlin
// ì˜ˆì‹œ: INDEX (name, email, age)

// âœ… COVERED QUERY
SELECT name, email FROM users WHERE name = 'Alice'
â†’ WHERE ì»¬ëŸ¼(name)ì´ leading column âœ“
â†’ SELECT ì»¬ëŸ¼(name, email)ì´ ëª¨ë‘ ì¸ë±ìŠ¤ì— í¬í•¨ âœ“
â†’ Result: COVERED_INDEX_SCAN (ë§¤ìš° ë¹ ë¦„!)

// âŒ NOT COVERED
SELECT name, email, address FROM users WHERE name = 'Alice'
â†’ WHERE ì»¬ëŸ¼(name)ì´ leading column âœ“
â†’ SELECT ì»¬ëŸ¼ì— addressê°€ ìˆëŠ”ë° ì¸ë±ìŠ¤ì— ì—†ìŒ âœ—
â†’ Result: INDEX_SCAN (ì¸ë±ìŠ¤ ì‚¬ìš©í•˜ì§€ë§Œ í…Œì´ë¸” ì ‘ê·¼ í•„ìš”)

// âŒ NOT COVERED
SELECT name, email FROM users WHERE email = 'alice@example.com'
â†’ WHERE ì»¬ëŸ¼(email)ì´ leading column ì•„ë‹˜ âœ—
â†’ Result: TABLE_SCAN (ì¸ë±ìŠ¤ ì‚¬ìš© ë¶ˆê°€)
```

### ë¹„ìš© ê³„ì‚° ê³µì‹

```kotlin
// INDEX_SCAN ë¹„ìš©
cost = log2(totalRows) + (totalRows * selectivity)
     = ì¸ë±ìŠ¤ íƒìƒ‰ ë¹„ìš© + ì‹¤ì œ ë°ì´í„° ì½ê¸° ë¹„ìš©

// ì˜ˆì‹œ: ì´ 1,000,000 í–‰, selectivity = 0.001 (0.1%)
cost = log2(1,000,000) + (1,000,000 * 0.001)
     = 19.93 + 1,000
     = 1,019.93

// TABLE_SCAN ë¹„ìš©
cost = totalRows
     = 1,000,000  (ëª¨ë“  í–‰ ìŠ¤ìº”)

// â†’ INDEX_SCANì´ ì•½ 1000ë°° ë¹ ë¦„!
```

### QueryPlan vs QueryLog ì°¨ì´

| í•­ëª© | QueryPlan | QueryLog |
|-----|-----------|----------|
| **ìš©ë„** | EXPLAIN ì‹¤í–‰ ê³„íš | ì‹¤ì œ ì¿¼ë¦¬ ì‹¤í–‰ ê¸°ë¡ |
| **ìƒì„± ì‹œì ** | EXPLAIN ëª…ë ¹ ì‹œ | ëª¨ë“  ì¿¼ë¦¬ ì‹¤í–‰ ì‹œ |
| **ì¸ë±ìŠ¤** | `db-query-plans` | `db-query-logs` |
| **ì£¼ìš” ì •ë³´** | ì‹¤í–‰ ê³„íš, ë¹„ìš©, Covered ì—¬ë¶€ | ì‹¤í–‰ ì‹œê°„, ìƒíƒœ, ì—ëŸ¬ |
| **ëª©ì ** | ì¿¼ë¦¬ ìµœì í™” ë¶„ì„ | ì„±ëŠ¥ ëª¨ë‹ˆí„°ë§, ë¡œê¹… |

## Query Logging & Monitoring Architecture

ì¿¼ë¦¬ ì‹¤í–‰ ë¡œê·¸ë¥¼ Elasticsearchì— ì €ì¥í•˜ê³  Kibanaë¡œ ì‹œê°í™”í•˜ì—¬ ë°ì´í„°ë² ì´ìŠ¤ ì˜µí‹°ë§ˆì´ì €ì˜ EXPLAINê³¼ ìœ ì‚¬í•œ ê¸°ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

### ì „ì²´ ì•„í‚¤í…ì²˜

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                          Docker Compose                                  â”‚
â”‚                                                                          â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”    â”‚
â”‚  â”‚   Elasticsearch     â”‚  â”‚     Kibana       â”‚  â”‚    DB Server      â”‚    â”‚
â”‚  â”‚   (Port 9200)       â”‚  â”‚   (Port 5601)    â”‚  â”‚   (Port 9000)     â”‚    â”‚
â”‚  â”‚                     â”‚  â”‚                  â”‚  â”‚                   â”‚    â”‚
â”‚  â”‚ - ì¿¼ë¦¬ ë¡œê·¸ ì¸ë±ì‹±      â”‚â—€â”€â”‚ - ë¡œê·¸ ì‹œê°í™”       â”‚  â”‚ - TCP Server      â”‚    â”‚
â”‚  â”‚ - ê²€ìƒ‰ ë° ì§‘ê³„         â”‚  â”‚ - ëŒ€ì‹œë³´ë“œ         â”‚   â”‚ - Query Execution â”‚    â”‚
â”‚  â”‚ - db-query-logs     â”‚  â”‚ - í†µê³„ ë¶„ì„        â”‚   â”‚ - Connection Mgmt â”‚    â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â–²â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜   â”‚
â”‚            â”‚                                               â”‚             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
             â”‚                                               â”‚
             â”‚ Index query logs                              â”‚
             â”‚ (HTTP REST API)                               â”‚
             â”‚                                               â”‚
             â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                         Query execution flow
```

### ì¿¼ë¦¬ ë¡œê¹… ë°ì´í„° íë¦„

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”                                              â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Client  â”‚                                              â”‚  DB Server       â”‚
â””â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”˜                                              â”‚  (db-server)     â”‚
     â”‚                                                   â””â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚ 1. SQL Query (CREATE TABLE, INSERT, SELECT...)            â”‚
     â”‚â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¶â”‚
     â”‚                                                            â”‚
     â”‚                                         2. ConnectionHandler
     â”‚                                            processes query â”‚
     â”‚                                                            â”‚
     â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                         â”‚    TableService           â”‚
     â”‚                                         â”‚  - Execute query          â”‚
     â”‚                                         â”‚  - Create/Insert/Select   â”‚
     â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                        â”‚
     â”‚                                         3. Query executed
     â”‚                                                        â”‚
     â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                         â”‚   QueryLogService         â”‚
     â”‚                                         â”‚  - Create QueryLog        â”‚
     â”‚                                         â”‚  - queryType: DDL/DML     â”‚
     â”‚                                         â”‚  - queryText, timestamp   â”‚
     â”‚                                         â”‚  - executionTimeMs        â”‚
     â”‚                                         â”‚  - status: SUCCESS/FAILED â”‚
     â”‚                                         â”‚  - affectedTables         â”‚
     â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                        â”‚
     â”‚                                         4. Index query log
     â”‚                                            (Spring Data Elasticsearch)
     â”‚                                                        â”‚
     â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                         â”‚   QueryLogRepository      â”‚
     â”‚                                         â”‚  - save(queryLog)         â”‚
     â”‚                                         â”‚  - ElasticsearchRepositoryâ”‚
     â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                        â”‚
     â”‚                                                        â”‚ HTTP POST
     â”‚                                                        â”‚ /_doc
     â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                         â”‚    Elasticsearch          â”‚
     â”‚                                         â”‚  Index: db-query-logs     â”‚
     â”‚                                         â”‚                           â”‚
     â”‚                                         â”‚  Documents:               â”‚
     â”‚                                         â”‚  {                        â”‚
     â”‚                                         â”‚    query_id: "uuid",      â”‚
     â”‚                                         â”‚    query_type: "DDL",     â”‚
     â”‚                                         â”‚    query_text: "CREATE.." â”‚
     â”‚                                         â”‚    timestamp: "2024-...", â”‚
     â”‚                                         â”‚    execution_time_ms: 45, â”‚
     â”‚                                         â”‚    status: "SUCCESS",     â”‚
     â”‚                                         â”‚    affected_tables: [...] â”‚
     â”‚                                         â”‚  }                        â”‚
     â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚                                                        â”‚
     â”‚ 5. Query result                                        â”‚
     â”‚â—€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
     â”‚                                                        â”‚
     â”‚                                                        â”‚
     â”‚                                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
     â”‚                                         â”‚       Kibana              â”‚
     â”‚                                         â”‚                           â”‚
     â”‚                                         â”‚  - Query logs discovery   â”‚
     â”‚                                         â”‚  - Visualization          â”‚
     â”‚                                         â”‚  - Statistics dashboard   â”‚
     â”‚                                         â”‚                           â”‚
     â”‚                                         â”‚  Queries:                 â”‚
     â”‚                                         â”‚  - affected_tables:"users"â”‚
     â”‚                                         â”‚  - query_type:"DDL"       â”‚
     â”‚                                         â”‚  - execution_time_ms>1000 â”‚
     â”‚                                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     â”‚
     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
```

### ì¿¼ë¦¬ ë¡œê·¸ ë°ì´í„° ëª¨ë¸

Elasticsearchì— ì €ì¥ë˜ëŠ” ì¿¼ë¦¬ ë¡œê·¸ ë¬¸ì„œ êµ¬ì¡°:

```kotlin
@Document(indexName = "db-query-logs")
data class QueryLog(
    @Id val queryId: String,                    // UUID
    val queryType: QueryType,                   // DDL, DML, DQL, DCL, TCL
    val queryText: String,                      // ì‹¤í–‰ëœ SQL ì¿¼ë¦¬
    val connectionId: String,                   // ì—°ê²° ID
    val user: String,                           // ì‚¬ìš©ìëª…
    val timestamp: Instant,                     // ì‹¤í–‰ ì‹œê°„
    val executionTimeMs: Long?,                 // ì‹¤í–‰ ì‹œê°„ (ë°€ë¦¬ì´ˆ)
    val status: QueryStatus,                    // SUCCESS, FAILED, IN_PROGRESS
    val errorMessage: String? = null,           // ì—ëŸ¬ ë©”ì‹œì§€
    val affectedTables: List<String>,           // ì˜í–¥ë°›ì€ í…Œì´ë¸” ëª©ë¡
    val rowsAffected: Int? = null,              // ì˜í–¥ë°›ì€ í–‰ ìˆ˜
    val metadata: Map<String, Any>? = null      // ì¶”ê°€ ë©”íƒ€ë°ì´í„°
)
```

### Docker Compose ì„œë¹„ìŠ¤ êµ¬ì„±

```yaml
services:
  elasticsearch:
    - DML/DDL ì¿¼ë¦¬ ë¡œê·¸ ì €ì¥
    - ê²€ìƒ‰ ë° ì§‘ê³„ ê¸°ëŠ¥
    - í˜¸ìŠ¤íŠ¸ Port: 9201 (HTTP), 9301 (Transport)
    - ì»¨í…Œì´ë„ˆ Port: 9200, 9300

  kibana:
    - Elasticsearch ë°ì´í„° ì‹œê°í™”
    - ëŒ€ì‹œë³´ë“œ ë° í†µê³„
    - í˜¸ìŠ¤íŠ¸ Port: 5602 (Web UI)
    - ì»¨í…Œì´ë„ˆ Port: 5601

  db-server:
    - TCP ì„œë²„
    - í˜¸ìŠ¤íŠ¸ Port: 9001
    - ì»¨í…Œì´ë„ˆ Port: 9000
    - ì¿¼ë¦¬ ì‹¤í–‰ ë° ë¡œê¹…
    - Elasticsearch ì—°ë™
```

### ë¹ ë¥¸ ì‹œì‘

```bash
# 1. ëª¨ë“  ì„œë¹„ìŠ¤ ì‹œì‘ (Elasticsearch + Kibana + DB Server)
docker compose up -d --build

# 2. ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
docker compose ps

# 3. Elasticsearch ì¸ë±ìŠ¤ ì´ˆê¸°í™”
./scripts/init-elasticsearch-index.sh

# 4. ì˜ˆì œ ì‹¤í–‰í•˜ì—¬ ì¿¼ë¦¬ ë¡œê·¸ ìƒì„±
cd db-server
./gradlew runQueryLogExample

# 5. Kibanaì—ì„œ ë¡œê·¸ í™•ì¸ (Docker í™˜ê²½)
# ë¸Œë¼ìš°ì €ì—ì„œ http://localhost:5602 ì ‘ì†
```

ìì„¸í•œ Elasticsearch ì„¤ì • ë° ì‚¬ìš©ë²•ì€ [ELASTICSEARCH.md](./ELASTICSEARCH.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

## ê°œë°œ í™˜ê²½

- **ì–¸ì–´**: Kotlin 1.9.25
- **í”„ë ˆì„ì›Œí¬**: Spring Boot 3.5.3
- **JDK**: Java 17
- **ë¹Œë“œ ë„êµ¬**: Gradle
- **ëª¨ë‹ˆí„°ë§**: Elasticsearch 8.11.1, Kibana 8.11.1
- **ì»¨í…Œì´ë„ˆ**: Docker & Docker Compose

## ë¹Œë“œ ë° ì‹¤í–‰

### ë°©ë²• 1: Docker Compose (ì¶”ì²œ)

ì „ì²´ ì‹œìŠ¤í…œì„ í•œ ë²ˆì— ì‹¤í–‰í•©ë‹ˆë‹¤ (Elasticsearch + Kibana + DB Server + API Server).

**ë¹ ë¥¸ ì‹œì‘:**
```bash
# BuildKit í™œì„±í™” (ë¹Œë“œ ìµœì í™”)
export DOCKER_BUILDKIT=1
export COMPOSE_DOCKER_CLI_BUILD=1

# ì „ì²´ ì„œë¹„ìŠ¤ ì‹¤í–‰ (ë³€ê²½ëœ ì„œë¹„ìŠ¤ë§Œ ì¬ë¹Œë“œ)
docker compose up -d --build

# ì„œë¹„ìŠ¤ ìƒíƒœ í™•ì¸
docker compose ps

# API í…ŒìŠ¤íŠ¸
curl http://localhost:8081/api/tables/ping

# ë¡œê·¸ í™•ì¸
docker compose logs -f api-server

# ì„œë¹„ìŠ¤ ì¤‘ì§€
docker compose down
```

**í¬íŠ¸ ì •ë³´ (Docker):**
- API Server: `http://localhost:8081`
- DB Server: `tcp://localhost:9001`
- Elasticsearch: `http://localhost:9201`
- Kibana: `http://localhost:5602`

**í¬íŠ¸ ì •ë³´ (ë¡œì»¬):**
- API Server: `http://localhost:8080`
- DB Server: `tcp://localhost:9000`
- Elasticsearch: `http://localhost:9200`
- Kibana: `http://localhost:5601`

**ë™ì‹œ ì‹¤í–‰ ê°€ëŠ¥:** ë¡œì»¬ê³¼ Dockerê°€ ì„œë¡œ ë‹¤ë¥¸ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ë¯€ë¡œ ê°™ì€ PCì—ì„œ ë™ì‹œì— ì‹¤í–‰í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. ìì„¸í•œ ë‚´ìš©ì€ [PROFILES.md](./PROFILES.md)ë¥¼ ì°¸ì¡°í•˜ì„¸ìš”.

**ë°ì´í„° ì˜ì†ì„±:**
- í…Œì´ë¸” ë°ì´í„°: `db_db-server-data` ë³¼ë¥¨ì— `*.dat` íŒŒì¼ í˜•ì‹ìœ¼ë¡œ ì €ì¥
- Elasticsearch ë°ì´í„°: `db_elasticsearch-data` ë³¼ë¥¨ì— ì €ì¥

**ë¹Œë“œ ìµœì í™”:**
- db-serverë§Œ ìˆ˜ì • ì‹œ 30ì´ˆ ë§Œì— ì¬ë¹Œë“œ (90% ê°ì†Œ) âš¡
- api-serverë§Œ ìˆ˜ì • ì‹œ 30ì´ˆ ë§Œì— ì¬ë¹Œë“œ (90% ê°ì†Œ) âš¡
- ë ˆì´ì–´ ìºì‹± ë° BuildKit ìºì‹œ ë§ˆìš´íŠ¸ í™œìš©

ìì„¸í•œ ì‚¬ìš©ë²•:
- ì¼ë°˜ ì‚¬ìš©: [DOCKER_GUIDE.md](./DOCKER_GUIDE.md)
- ë¹Œë“œ ìµœì í™”: [DOCKER_BUILD_GUIDE.md](./DOCKER_BUILD_GUIDE.md)

### ë°©ë²• 2: ë¡œì»¬ ì‹¤í–‰ (Gradle)

Gradleì„ ì‚¬ìš©í•˜ì—¬ ì§ì ‘ ì‹¤í–‰í•©ë‹ˆë‹¤.

```bash
# ì „ì²´ ë¹Œë“œ
./gradlew build

# DB ì„œë²„ ì‹¤í–‰
./gradlew :db-server:bootRun

# API ì„œë²„ ì‹¤í–‰ (ë³„ë„ í„°ë¯¸ë„)
./gradlew :api-server:bootRun

# í…ŒìŠ¤íŠ¸
./gradlew test
```

**ì£¼ì˜:** Elasticsearchì™€ Kibanaê°€ í•„ìš”í•œ EXPLAIN ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ë ¤ë©´ ë¨¼ì € Docker Composeë¡œ Elasticsearchë¥¼ ì‹¤í–‰í•´ì•¼ í•©ë‹ˆë‹¤:
```bash
docker compose up -d elasticsearch kibana
```

## API ì‚¬ìš© ë°©ë²•

### REST API ì—”ë“œí¬ì¸íŠ¸

API ì„œë²„ëŠ” HTTP REST APIë¥¼ ì œê³µí•©ë‹ˆë‹¤.

**Docker í™˜ê²½ (í¬íŠ¸ 8081):**

```bash
# CREATE TABLE
curl -X POST http://localhost:8081/api/tables/create \
  -H "Content-Type: application/json" \
  -d '{"query": "CREATE TABLE users (id INT, name VARCHAR, age INT)"}'

# INSERT
curl -X POST http://localhost:8081/api/tables/insert \
  -H "Content-Type: application/json" \
  -d '{"query": "INSERT INTO users VALUES (id=\"1\", name=\"John\", age=\"30\")"}'

# SELECT
curl -X GET 'http://localhost:8081/api/tables/select?query=SELECT%20*%20FROM%20users'

# EXPLAIN
curl -X GET 'http://localhost:8081/api/tables/query-plan?query=EXPLAIN%20SELECT%20*%20FROM%20users'

# DROP TABLE
curl -X DELETE 'http://localhost:8081/api/tables/drop?query=DROP%20TABLE%20users'
```

**ë¡œì»¬ í™˜ê²½ (í¬íŠ¸ 8080):**

```bash
# í¬íŠ¸ë§Œ 8080ìœ¼ë¡œ ë³€ê²½í•˜ë©´ ë©ë‹ˆë‹¤
curl -X POST http://localhost:8080/api/tables/create ...
```

### ìë™í™”ëœ í…ŒìŠ¤íŠ¸

```bash
# ì „ì²´ í…ŒìŠ¤íŠ¸ ì‹œë‚˜ë¦¬ì˜¤ ì‹¤í–‰ (5ê°œ í…Œì´ë¸”, 19ê°œ ë ˆì½”ë“œ)
cd api-server
./test-api-requests.sh
```

ìì„¸í•œ API ì‚¬ìš©ë²•ì€ ë‹¤ìŒ ë¬¸ì„œë¥¼ ì°¸ì¡°í•˜ì„¸ìš”:
- [API_USAGE.md](./api-server/API_USAGE.md) - ì „ì²´ API ê°€ì´ë“œ
- [TEST_README.md](./api-server/TEST_README.md) - í…ŒìŠ¤íŠ¸ ë°©ë²•

## í”„ë¡œí† ì½œ ì•„í‚¤í…ì²˜

### ë‹¨ìˆœí™”ëœ String ê¸°ë°˜ í”„ë¡œí† ì½œ

í”„ë¡œì íŠ¸ ì´ˆê¸°ì—ëŠ” `DbRequest`ì™€ `DbCommand` enumì„ ì‚¬ìš©í•œ êµ¬ì¡°í™”ëœ í”„ë¡œí† ì½œì„ ì‚¬ìš©í–ˆìœ¼ë‚˜, ë¶ˆí•„ìš”í•œ ë³µì¡ì„±ì„ ì œê±°í•˜ê³  **ìˆœìˆ˜ String ê¸°ë°˜ í”„ë¡œí† ì½œ**ë¡œ ë‹¨ìˆœí™”í–ˆìŠµë‹ˆë‹¤.

#### ì´ì „ í”„ë¡œí† ì½œ (ë³µì¡)

```kotlin
// í´ë¼ì´ì–¸íŠ¸ ì¸¡
val request = DbRequest(
    command = DbCommand.RAW_SQL,
    sql = "CREATE TABLE users (id INT, name VARCHAR)"
)
val requestBytes = ProtocolCodec.encodeRequest(request)  // JSON ì§ë ¬í™”
// â†’ {"command":"RAW_SQL","sql":"CREATE TABLE..."}

// ì„œë²„ ì¸¡
val request = ProtocolCodec.decodeRequest(bytes)  // JSON ì—­ì§ë ¬í™”
val sql = request.sql  // SQL ì¶”ì¶œ
// SQL íŒŒì‹± ë° ì²˜ë¦¬...
```

**ë¬¸ì œì :**
- ì¤‘ë³µëœ ê³„ì¸µ: `DbCommand.RAW_SQL`ì´ ë‹¨ìˆœíˆ SQL ë¬¸ìì—´ì„ ê°ì‹¸ëŠ” ë˜í¼ ì—­í• ë§Œ ìˆ˜í–‰
- ë¶ˆí•„ìš”í•œ JSON ì§ë ¬í™”/ì—­ì§ë ¬í™” ì˜¤ë²„í—¤ë“œ
- DbRequest, DbCommand í´ë˜ìŠ¤ ìœ ì§€ë³´ìˆ˜ í•„ìš”

#### í˜„ì¬ í”„ë¡œí† ì½œ (ë‹¨ìˆœ)

```kotlin
// í´ë¼ì´ì–¸íŠ¸ ì¸¡
val sql = "CREATE TABLE users (id INT, name VARCHAR)"
val requestBytes = ProtocolCodec.encodeRequest(sql)  // UTF-8 ì¸ì½”ë”©
// â†’ "CREATE TABLE users..."

// ì„œë²„ ì¸¡
val sql = ProtocolCodec.decodeRequest(bytes)  // UTF-8 ë””ì½”ë”©
// SQL íŒŒì‹± ë° ì²˜ë¦¬...
```

**ì¥ì :**
- ë‹¨ìˆœì„±: SQL ë¬¸ìì—´ì„ ì§ì ‘ ì „ì†¡
- ì„±ëŠ¥: JSON ì§ë ¬í™” ë¶ˆí•„ìš”, UTF-8 ì¸ì½”ë”©ë§Œ ìˆ˜í–‰
- ìœ ì§€ë³´ìˆ˜: ì¤‘ê°„ DTO í´ë˜ìŠ¤ ì œê±°

### í”„ë¡œí† ì½œ ë©”ì‹œì§€ í˜•ì‹

#### ìš”ì²­ ë©”ì‹œì§€ (Client â†’ Server)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Length (4 byte)â”‚ SQL String (UTF-8)           â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x00000023     â”‚ "CREATE TABLE users ..."     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     35 bytes           SQL ë‚´ìš©
```

#### ì‘ë‹µ ë©”ì‹œì§€ (Server â†’ Client)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Length (4 byte)â”‚ JSON Response (UTF-8)        â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ 0x0000004A     â”‚ {"success":true,...}         â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
     74 bytes          DbResponse JSON
```

### ProtocolCodec êµ¬í˜„

```kotlin
object ProtocolCodec {
    // ìš”ì²­ ì¸ì½”ë”©: SQL ë¬¸ìì—´ â†’ ë°”ì´íŠ¸ ë°°ì—´
    fun encodeRequest(sql: String): ByteArray {
        return sql.toByteArray(StandardCharsets.UTF_8)
    }

    // ìš”ì²­ ë””ì½”ë”©: ë°”ì´íŠ¸ ë°°ì—´ â†’ SQL ë¬¸ìì—´
    fun decodeRequest(bytes: ByteArray): String {
        return bytes.toString(StandardCharsets.UTF_8)
    }

    // ì‘ë‹µ ì¸ì½”ë”©: DbResponse â†’ JSON ë°”ì´íŠ¸ ë°°ì—´
    fun encodeResponse(response: DbResponse): ByteArray {
        val jsonString = json.encodeToString(response)
        return jsonString.toByteArray(StandardCharsets.UTF_8)
    }

    // ì‘ë‹µ ë””ì½”ë”©: JSON ë°”ì´íŠ¸ ë°°ì—´ â†’ DbResponse
    fun decodeResponse(bytes: ByteArray): DbResponse {
        val jsonString = bytes.toString(StandardCharsets.UTF_8)
        return json.decodeFromString(jsonString)
    }

    // ë©”ì‹œì§€ ì“°ê¸°: ê¸¸ì´(4 byte) + ë°ì´í„°
    fun writeMessage(output: OutputStream, data: ByteArray) {
        val dos = DataOutputStream(output)
        dos.writeInt(data.size)
        dos.write(data)
        dos.flush()
    }

    // ë©”ì‹œì§€ ì½ê¸°: ê¸¸ì´ ì½ê³  â†’ ë°ì´í„° ì½ê¸°
    fun readMessage(input: InputStream): ByteArray {
        val dis = DataInputStream(input)
        val length = dis.readInt()
        val data = ByteArray(length)
        dis.readFully(data)
        return data
    }
}
```

### ì§€ì›í•˜ëŠ” SQL ëª…ë ¹

ì„œë²„ëŠ” ë‹¤ìŒ SQL ëª…ë ¹ì„ íŒŒì‹±í•˜ê³  ì²˜ë¦¬í•©ë‹ˆë‹¤ (ìì„¸í•œ ë‚´ìš©ì€ [ğŸ“‹ ì§€ì› ê¸°ëŠ¥](#-ì§€ì›-ê¸°ëŠ¥) ì„¹ì…˜ ì°¸ì¡°):

- **CREATE TABLE**: í…Œì´ë¸” ìƒì„±
- **INSERT**: ë ˆì½”ë“œ ì‚½ì…
- **SELECT**: ì „ì²´ í…Œì´ë¸” ìŠ¤ìº” (WHERE ì ˆ ë¯¸ì§€ì›)
- **DROP TABLE**: í…Œì´ë¸” ì‚­ì œ
- **EXPLAIN**: ì¿¼ë¦¬ ì‹¤í–‰ ê³„íš ë¶„ì„
- **PING**: ì—°ê²° í™•ì¸

### ConnectionHandler SQL íŒŒì‹±

```kotlin
private fun processRequest(sql: String): DbResponse {
    val trimmedSql = sql.trim().trimEnd(';')

    // PING ëª…ë ¹ ì²˜ë¦¬
    if (trimmedSql.equals("PING", ignoreCase = true)) {
        return DbResponse(success = true, message = "pong")
    }

    return when {
        trimmedSql.startsWith("CREATE TABLE", ignoreCase = true)
            -> parseAndHandleCreateTable(trimmedSql)
        trimmedSql.startsWith("INSERT INTO", ignoreCase = true)
            -> parseAndHandleInsert(trimmedSql)
        trimmedSql.startsWith("SELECT", ignoreCase = true)
            -> parseAndHandleSelect(trimmedSql)
        trimmedSql.startsWith("DROP TABLE", ignoreCase = true)
            -> parseAndHandleDropTable(trimmedSql)
        trimmedSql.startsWith("EXPLAIN", ignoreCase = true)
            -> parseAndHandleExplain(trimmedSql)
        else -> DbResponse(
            success = false,
            message = "Unsupported SQL query: $sql",
            errorCode = 400
        )
    }
}
```

### ì•„í‚¤í…ì²˜ ë¹„êµ

#### ì´ì „ (ë³µì¡í•œ ê³„ì¸µ)
```
Client: SQL â†’ DbRequest(RAW_SQL) â†’ JSON â†’ TCP â†’ Server
Server: TCP â†’ JSON â†’ DbRequest â†’ SQL ì¶”ì¶œ â†’ íŒŒì‹± â†’ ì‹¤í–‰
```

#### í˜„ì¬ (ë‹¨ìˆœí•œ íë¦„)
```
Client: SQL â†’ UTF-8 â†’ TCP â†’ Server
Server: TCP â†’ UTF-8 â†’ SQL â†’ íŒŒì‹± â†’ ì‹¤í–‰
```

**ì œê±°ëœ íŒŒì¼:**
- `common/protocol/DbRequest.kt` - ìš”ì²­ DTO
- `common/protocol/DbCommand.kt` - ëª…ë ¹ enum
- `api-server/util/SqlParser.kt` - API ì„œë²„ì˜ SQL íŒŒì„œ (db-serverë¡œ í†µí•©)

**ë³€ê²½ëœ íŒŒì¼:**
- `common/protocol/ProtocolCodec.kt` - String ì¸ì½”ë”©/ë””ì½”ë”©ìœ¼ë¡œ ë‹¨ìˆœí™”
- `db-server/ConnectionHandler.kt` - SQL ë¬¸ìì—´ ì§ì ‘ ì²˜ë¦¬
- `api-server/DbClient.kt` - SQL ë¬¸ìì—´ ì§ì ‘ ì „ì†¡
- `api-server/TableController.kt` - DbRequest ìƒì„± ì œê±°

## ğŸ“š ë¬¸ì„œ ëª©ë¡

í”„ë¡œì íŠ¸ì˜ ìƒì„¸ ê°€ì´ë“œ ë¬¸ì„œ:

| ë¬¸ì„œ | ì„¤ëª… |
|------|------|
| [README.md](./README.md) | í”„ë¡œì íŠ¸ ê°œìš”, ì•„í‚¤í…ì²˜, API ì‚¬ìš©ë²• |
| [BUFFER_POOL_GUIDE.md](./BUFFER_POOL_GUIDE.md) | **Buffer Pool ê°œë… ë° ì›ë¦¬** (LRU ìºì‹±, ì„±ëŠ¥ ìµœì í™”) |
| [DOCKER_GUIDE.md](./DOCKER_GUIDE.md) | Docker Compose ì‚¬ìš© ê°€ì´ë“œ (ì‹¤í–‰, ë¡œê·¸, íŠ¸ëŸ¬ë¸”ìŠˆíŒ…) |
| [DOCKER_BUILD_GUIDE.md](./DOCKER_BUILD_GUIDE.md) | Docker ë¹Œë“œ ìµœì í™” ê°€ì´ë“œ (ë ˆì´ì–´ ìºì‹±, BuildKit) |
| [EXPLAIN_GUIDE.md](./EXPLAIN_GUIDE.md) | EXPLAIN ì¿¼ë¦¬ ë¶„ì„ ê¸°ëŠ¥ ìƒì„¸ ê°€ì´ë“œ |
| [PROFILES.md](./PROFILES.md) | Spring Profile ì„¤ì • ë° í™˜ê²½ë³„ êµ¬ì„± |

**í•µì‹¬ ê°œë…:**
- **Buffer Pool**: BUFFER_POOL_GUIDE.md (í˜ì´ì§€ ìºì‹±, LRU, ì„±ëŠ¥ ìµœì í™”)
- **ë””ìŠ¤í¬ I/O**: README.md > "ë””ìŠ¤í¬ ê¸°ë°˜ ì˜ì†ì„±" ì„¹ì…˜
- **Thread-Safety**: README.md > "Thread-Safety ë³´ì¥" ì„¹ì…˜
- **EXPLAIN**: EXPLAIN_GUIDE.md
- **Docker ìµœì í™”**: DOCKER_BUILD_GUIDE.md

